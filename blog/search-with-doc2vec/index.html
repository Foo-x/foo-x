<!DOCTYPE html><html lang="ja"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.7.0"/><meta name="theme-color" content="#222933"/><meta name="description" content="Doc2Vecで類似文章を検索してみたので、実装を紹介します。 Doc2Vecとは コンピュータが自然言語を処理するためには、まず人間の言葉をコンピュータで扱える値にする必要があります。
単語の意味をベクトル化する手法としてWord2Vec…" data-gatsby-head="true"/><meta name="og:title" content="文章をベクトル化して類似文章の検索 | foo-x" data-gatsby-head="true"/><meta name="og:description" content="Doc2Vecで類似文章を検索してみたので、実装を紹介します。 Doc2Vecとは コンピュータが自然言語を処理するためには、まず人間の言葉をコンピュータで扱える値にする必要があります。
単語の意味をベクトル化する手法としてWord2Vec…" data-gatsby-head="true"/><meta name="og:type" content="website" data-gatsby-head="true"/><meta name="og:image" content="https://foo-x.com/static/f5715df17178255085d9663920fff296/ogp.jpg" data-gatsby-head="true"/><meta name="og:url" content="https://foo-x.com/blog/search-with-doc2vec/" data-gatsby-head="true"/><meta name="twitter:card" content="summary_large_image" data-gatsby-head="true"/><link data-identity="gatsby-global-css" href="/styles.01552253e164ab65ada8.css" rel="stylesheet" type="text/css"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="alternate" type="application/rss+xml" title="foo-x" href="/rss.xml"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=b00eea9b3e376ef94fc5fe666ba3327e"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=b00eea9b3e376ef94fc5fe666ba3327e"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=b00eea9b3e376ef94fc5fe666ba3327e"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=b00eea9b3e376ef94fc5fe666ba3327e"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=b00eea9b3e376ef94fc5fe666ba3327e"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=b00eea9b3e376ef94fc5fe666ba3327e"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=b00eea9b3e376ef94fc5fe666ba3327e"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=b00eea9b3e376ef94fc5fe666ba3327e"/><link as="font" href="/static/roboto-latin-400-normal-b009a76ad6afe4ebd301e36f847a29be.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/roboto-latin-700-normal-227c93190fe7f82de3f802ce0b614d3b.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/roboto-mono-latin-400-normal-6f5d6510e56fac3cd6090fc7c7d6e5b5.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-97-400-normal-02bcd93ee85dba5ba402fcadf16ab203.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-116-400-normal-1f6f737a70d4aaa0c22771d62c13b78e.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-119-400-normal-328bed30ee8d501d069ee3d26728f111.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-114-400-normal-d4e9f9c16b1cfb545729a81f4ab70ad9.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-110-400-normal-63a8d6f8e62379c37c9e23e1f2324527.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-102-400-normal-60410b3303c65185cddbe18cf756224b.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-114-700-normal-3c61bcc198dc2161522a0544cb8d60d4.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-117-700-normal-903dd5f146cdd84d27b679b6d8f14a9b.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-119-700-normal-fc0ba8ba5450816f699155aa11a5cf3f.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-109-700-normal-ecd55ccc07b257b0d253bdc8459f91e1.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-115-700-normal-5e6e181e7dd2d60693bd45da7b831bce.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-106-400-normal-1c6ce8e1f213be81c1baa81944bde869.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-115-400-normal-40953f9c82862eda86697566a401d279.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-113-400-normal-81ba163298e27d7b5bc6381d81439628.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-112-400-normal-35d1479071a960c1cbf035274c0aaec1.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-106-700-normal-45783e0a228c6613f1d2791d594d3b85.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-109-400-normal-221a00674d70914eb867cddb11007255.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-112-700-normal-a6507b38ba5d665d1bea915f5d7e52c9.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-111-400-normal-b7a4bd8fc702b50d47eff9b92f927871.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-107-400-normal-e076991ab02b9125d6936374943f89e2.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-96-400-normal-73bee1e785307d8efc3c3c202ba6006d.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-82-400-normal-6d192fc463c36bfc8b035c6497924675.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-108-400-normal-2a30aacbb14d15e75c0c2b8ac8d55fc1.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-104-400-normal-33915a597d48bab641ded299bbb9059d.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-92-400-normal-5ab975b321799816fd52668d9ad35d67.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-85-400-normal-1ec5aea27494d49b015124b8997660a1.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-10-400-normal-797e79b2856c06e484fb00fd557cd18f.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-105-400-normal-d4cad79c314b29fbfaf0368ae7385d5d.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-94-400-normal-87843528f829f0b1d8808d5d1e590d13.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-100-400-normal-c7414541582c0d22731f9521db696d5b.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-99-400-normal-5f326addeacbce2cf55e5e8f11b12f84.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-32-400-normal-33c0cf8b5289eb2a4d54d2413f856d25.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-83-400-normal-92fca974b731ad9802d612f0365e74b7.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-71-400-normal-17755069a1899917e1e2bd11c26c3a82.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-103-400-normal-e5f8879dabb5675fdded53665e662ed8.woff2" rel="preload" crossorigin="anonymous"/><link as="font" href="/static/noto-sans-jp-90-400-normal-891e164caa3921457d868df391b8d052.woff2" rel="preload" crossorigin="anonymous"/><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-XNZ8Y97RCM"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-XNZ8Y97RCM', {"send_page_view":false});
      }
      </script><title data-gatsby-head="true">文章をベクトル化して類似文章の検索 | foo-x</title><link rel="icon" type="image/png" href="/favicon.png" data-gatsby-head="true"/></head><body class="Seo-module--bodyBlogPost--236c9"><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="global-wrapper" data-is-root-path="false"><header class="Layout-module--globalHeader--128e8" style="height:-1px"><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper HeaderBlogPost-module--blogPostHeaderImage--69ae3"><div aria-hidden="true" style="padding-top:66.66666666666666%"></div><div aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear"></div><picture><source type="image/webp" data-srcset="/static/f27fb428c244155a8bdbee7cf7f68de2/57584/header.webp 750w,/static/f27fb428c244155a8bdbee7cf7f68de2/984df/header.webp 1080w,/static/f27fb428c244155a8bdbee7cf7f68de2/4a276/header.webp 1366w,/static/f27fb428c244155a8bdbee7cf7f68de2/9c00f/header.webp 1920w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="100vw" decoding="async" loading="lazy" data-src="/static/f27fb428c244155a8bdbee7cf7f68de2/5267c/header.jpg" data-srcset="/static/f27fb428c244155a8bdbee7cf7f68de2/7284f/header.jpg 750w,/static/f27fb428c244155a8bdbee7cf7f68de2/29ba9/header.jpg 1080w,/static/f27fb428c244155a8bdbee7cf7f68de2/c8896/header.jpg 1366w,/static/f27fb428c244155a8bdbee7cf7f68de2/5267c/header.jpg 1920w" alt="header"/></picture><noscript><picture><source type="image/webp" srcSet="/static/f27fb428c244155a8bdbee7cf7f68de2/57584/header.webp 750w,/static/f27fb428c244155a8bdbee7cf7f68de2/984df/header.webp 1080w,/static/f27fb428c244155a8bdbee7cf7f68de2/4a276/header.webp 1366w,/static/f27fb428c244155a8bdbee7cf7f68de2/9c00f/header.webp 1920w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="100vw" decoding="async" loading="lazy" src="/static/f27fb428c244155a8bdbee7cf7f68de2/5267c/header.jpg" srcSet="/static/f27fb428c244155a8bdbee7cf7f68de2/7284f/header.jpg 750w,/static/f27fb428c244155a8bdbee7cf7f68de2/29ba9/header.jpg 1080w,/static/f27fb428c244155a8bdbee7cf7f68de2/c8896/header.jpg 1366w,/static/f27fb428c244155a8bdbee7cf7f68de2/5267c/header.jpg 1920w" alt="header"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div></header><nav class="global-nav-wrapper is-hidden"><div class="Nav-module--globalNav--d4bee"><a href="/"><img class="BrandIcon-module--brandIcon--93e32" src="/favicon.svg" alt="brand icon"/></a><div class="menu-wrapper"><nav class="Menu-module--menuNav--0c92d is-hidden"><ul><li><a href="/"><img src="/static/29ef402f4856f898797aba4d9f65cd90/home.svg" alt="home"/></a></li><li><a href="/works/"><img src="/static/e9011768c6d5ccef18580a07fc8b310e/works.svg" alt="works"/></a></li><li><a href="/archive/"><img src="/static/e95bf23d92aeeba5ff823926e900d1df/archive.svg" alt="archive"/></a></li><li><a href="/about/"><img src="/static/f3711c2fd2802b47ed9e403c85932043/about.svg" alt="about"/></a></li></ul></nav><svg class="Menu-module--hamburger--c87a8" viewBox="0 0 100 100" width="32"><path class="Menu-module--line--a5408 Menu-module--top--1add3" d="m 30,33 h 40 c 3.722839,0 7.5,3.126468 7.5,8.578427 0,5.451959 -2.727029,8.421573 -7.5,8.421573 h -20"></path><path class="Menu-module--line--a5408 Menu-module--middle--d5917" d="m 30,50 h 40"></path><path class="Menu-module--line--a5408 Menu-module--bottom--ab8b3" d="m 70,67 h -40 c 0,0 -7.5,-0.802118 -7.5,-8.365747 0,-7.563629 7.5,-8.634253 7.5,-8.634253 h 20"></path></svg></div></div></nav><main class="global-main"><article class="BlogPost-module--blogPost--42d82" itemscope="" itemType="http://schema.org/Article"><header><h1 itemProp="headline">文章をベクトル化して類似文章の検索</h1><time dateTime="2017-02-26">2017.02.26</time><ul class="BlogPost-module--blogPostTagList--95fda"><li><a href="/archive/?tag=python">python</a></li><li><a href="/archive/?tag=word2vec">word2vec</a></li><li><a href="/archive/?tag=doc2vec">doc2vec</a></li></ul><nav><header>目次</header><hr/><section><ul>
<li>
<a href="#doc2vec%E3%81%A8%E3%81%AF">Doc2Vecとは</a>
</li>
<li>
<a href="#%E5%AE%9F%E8%A3%85%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB">実装サンプル</a>
<ul>
<li><a href="#%E7%92%B0%E5%A2%83">環境</a></li>
<li><a href="#%E5%AD%A6%E7%BF%92">学習</a></li>
<li><a href="#%E5%8D%98%E8%AA%9E%E3%81%A7%E6%96%87%E7%AB%A0%E3%82%92%E6%A4%9C%E7%B4%A2">単語で文章を検索</a></li>
<li><a href="#%E9%A1%9E%E4%BC%BC%E6%96%87%E7%AB%A0%E3%81%AE%E6%A4%9C%E7%B4%A2">類似文章の検索</a></li>
</ul>
</li>
<li>
<a href="#%E3%81%BE%E3%81%A8%E3%82%81">まとめ</a>
</li>
<li>
<a href="#%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E8%B5%B7%E3%81%8D%E3%81%9F%E5%A0%B4%E5%90%88">エラーが起きた場合</a>
</li>
<li>
<a href="#%E5%8F%82%E8%80%83">参考</a>
</li>
</ul></section><hr/></nav></header><section class="BlogPost-module--blogPostBody--60756" itemProp="articleBody"><p>Doc2Vecで類似文章を検索してみたので、実装を紹介します。</p>
<h2 id="doc2vecとは" style="position:relative;"><a href="#doc2vec%E3%81%A8%E3%81%AF" aria-label="doc2vecとは permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Doc2Vecとは</h2>
<p>コンピュータが自然言語を処理するためには、まず人間の言葉をコンピュータで扱える値にする必要があります。
単語の意味をベクトル化する手法として<a href="https://deepage.net/bigdata/machine_learning/2016/09/02/word2vec_power_of_word_vector.html" target="_blank" rel="nofollow noopener noreferrer">Word2Vec</a>が存在します。
詳しくはリンク先がとてもわかりやすいのですが、ざっくり言うと前後n単語のリストでその単語を表現します。
こうすることで、例えば「犬」と「猫」は同じような文脈で使われるため、似た「意味」であると考えることができます。
Doc2VecはWord2Vecを応用し、文章をベクトル化するものです。</p>
<h2 id="実装サンプル" style="position:relative;"><a href="#%E5%AE%9F%E8%A3%85%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB" aria-label="実装サンプル permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>実装サンプル</h2>
<p>今回Doc2Vecを用いて実現するのは、以下の2つの機能です。</p>
<ul>
<li>単語で文章を検索</li>
<li>類似文章の検索</li>
</ul>
<p>サンプルとして、青空文庫の文章を使用しました。
なお、この記事で使用するコードは<a href="https://github.com/Foo-x/doc2vec-sample" target="_blank" rel="nofollow noopener noreferrer">GitHubで公開しています</a>。
(学習に使用した文章もzipにしましたが、サイズが大きいので注意してください)</p>
<h3 id="環境" style="position:relative;"><a href="#%E7%92%B0%E5%A2%83" aria-label="環境 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>環境</h3>
<ul>
<li>Python 3</li>
<li>MeCab</li>
<li>gensim</li>
</ul>
<p>を使えるようにしてください。</p>
<h3 id="学習" style="position:relative;"><a href="#%E5%AD%A6%E7%BF%92" aria-label="学習 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>学習</h3>
<ol>
<li>文章のファイルを取得</li>
<li>ファイルから文章を取得</li>
<li>文章から不要な部分を削除</li>
<li>単語に分解</li>
<li>Doc2Vecで学習</li>
<li>学習データを出力</li>
</ol>
<p>の流れで処理します。</p>
<h4 id="1-文章のファイルを取得" style="position:relative;"><a href="#1-%E6%96%87%E7%AB%A0%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E5%BE%97" aria-label="1 文章のファイルを取得 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. 文章のファイルを取得</h4>
<div class="gatsby-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> MeCab
<span class="token keyword">import</span> collections
<span class="token keyword">from</span> gensim <span class="token keyword">import</span> models
<span class="token keyword">from</span> gensim<span class="token punctuation">.</span>models<span class="token punctuation">.</span>doc2vec <span class="token keyword">import</span> LabeledSentence</code></pre></div>
<p>まずは必要ライブラリのインポートです。</p>
<div class="gatsby-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_all_files</span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> root<span class="token punctuation">,</span> dirs<span class="token punctuation">,</span> files <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>
            <span class="token keyword">yield</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span></code></pre></div>
<p>与えられたディレクトリ以下のファイルをすべて取得します。</p>
<h4 id="2-ファイルから文章を取得" style="position:relative;"><a href="#2-%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8B%E3%82%89%E6%96%87%E7%AB%A0%E3%82%92%E5%8F%96%E5%BE%97" aria-label="2 ファイルから文章を取得 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. ファイルから文章を取得</h4>
<div class="gatsby-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">def</span> <span class="token function">read_document</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'sjis'</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">return</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<h4 id="3-文章から不要な部分を削除" style="position:relative;"><a href="#3-%E6%96%87%E7%AB%A0%E3%81%8B%E3%82%89%E4%B8%8D%E8%A6%81%E3%81%AA%E9%83%A8%E5%88%86%E3%82%92%E5%89%8A%E9%99%A4" aria-label="3 文章から不要な部分を削除 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3. 文章から不要な部分を削除</h4>
<div class="gatsby-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">def</span> <span class="token function">trim_doc</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">:</span>
    lines <span class="token operator">=</span> doc<span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    valid_lines <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    is_valid <span class="token operator">=</span> <span class="token boolean">False</span>
    horizontal_rule_cnt <span class="token operator">=</span> <span class="token number">0</span>
    break_cnt <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> lines<span class="token punctuation">:</span>
        <span class="token keyword">if</span> horizontal_rule_cnt <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token keyword">and</span> <span class="token string">'-----'</span> <span class="token keyword">in</span> line<span class="token punctuation">:</span>
            horizontal_rule_cnt <span class="token operator">+=</span> <span class="token number">1</span>
            is_valid <span class="token operator">=</span> horizontal_rule_cnt <span class="token operator">==</span> <span class="token number">2</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span><span class="token punctuation">(</span>is_valid<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> line <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
            break_cnt <span class="token operator">+=</span> <span class="token number">1</span>
            is_valid <span class="token operator">=</span> break_cnt <span class="token operator">!=</span> <span class="token number">3</span>
            <span class="token keyword">continue</span>
        break_cnt <span class="token operator">=</span> <span class="token number">0</span>
        valid_lines<span class="token punctuation">.</span>append<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>valid_lines<span class="token punctuation">)</span></code></pre></div>
<p>ここは対象の文章によって処理が変わると思います。
今回は本文の前後にある文章の説明部分を無視するようにしました。
そもそもこれがどこまで精度に関わるのかは不明です。</p>
<h4 id="4-単語に分解" style="position:relative;"><a href="#4-%E5%8D%98%E8%AA%9E%E3%81%AB%E5%88%86%E8%A7%A3" aria-label="4 単語に分解 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4. 単語に分解</h4>
<div class="gatsby-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">def</span> <span class="token function">split_into_words</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    mecab <span class="token operator">=</span> MeCab<span class="token punctuation">.</span>Tagger<span class="token punctuation">(</span><span class="token string">"-Ochasen"</span><span class="token punctuation">)</span>
    valid_doc <span class="token operator">=</span> trim_doc<span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
    lines <span class="token operator">=</span> mecab<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> lines<span class="token punctuation">:</span>
        chunks <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chunks<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">3</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>chunks<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'動詞'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> chunks<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'形容詞'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>chunks<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'名詞'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> chunks<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'名詞-数'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            words<span class="token punctuation">.</span>append<span class="token punctuation">(</span>chunks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> LabeledSentence<span class="token punctuation">(</span>words<span class="token operator">=</span>words<span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">corpus_to_sentences</span><span class="token punctuation">(</span>corpus<span class="token punctuation">)</span><span class="token punctuation">:</span>
    docs <span class="token operator">=</span> <span class="token punctuation">[</span>read_document<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> corpus<span class="token punctuation">]</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>doc<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>docs<span class="token punctuation">,</span> corpus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'\r前処理中 {} / {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>corpus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> split_into_words<span class="token punctuation">(</span>doc<span class="token punctuation">,</span> name<span class="token punctuation">)</span></code></pre></div>
<p>ファイルから文章を取得し、単語に分解します。
精度を上げるために、学習に使う単語を名詞のみにすることがあるようです。
今回は動詞・形容詞・名詞(数詞以外)にしました。</p>
<h4 id="5-doc2vecで学習" style="position:relative;"><a href="#5-doc2vec%E3%81%A7%E5%AD%A6%E7%BF%92" aria-label="5 doc2vecで学習 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>5. Doc2Vecで学習</h4>
<div class="gatsby-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>sentences<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model <span class="token operator">=</span> models<span class="token punctuation">.</span>Doc2Vec<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.0015</span><span class="token punctuation">,</span> sample<span class="token operator">=</span><span class="token number">1e-4</span><span class="token punctuation">,</span> min_count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>build_vocab<span class="token punctuation">(</span>sentences<span class="token punctuation">)</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span>sentences<span class="token punctuation">)</span>
        ranks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> doc_id <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            inferred_vector <span class="token operator">=</span> model<span class="token punctuation">.</span>infer_vector<span class="token punctuation">(</span>sentences<span class="token punctuation">[</span>doc_id<span class="token punctuation">]</span><span class="token punctuation">.</span>words<span class="token punctuation">)</span>
            sims <span class="token operator">=</span> model<span class="token punctuation">.</span>docvecs<span class="token punctuation">.</span>most_similar<span class="token punctuation">(</span><span class="token punctuation">[</span>inferred_vector<span class="token punctuation">]</span><span class="token punctuation">,</span> topn<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>docvecs<span class="token punctuation">)</span><span class="token punctuation">)</span>
            rank <span class="token operator">=</span> <span class="token punctuation">[</span>docid <span class="token keyword">for</span> docid<span class="token punctuation">,</span> sim <span class="token keyword">in</span> sims<span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">(</span>sentences<span class="token punctuation">[</span>doc_id<span class="token punctuation">]</span><span class="token punctuation">.</span>tags<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            ranks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rank<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>collections<span class="token punctuation">.</span>Counter<span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> collections<span class="token punctuation">.</span>Counter<span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">>=</span> PASSING_PRECISION<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">return</span> model</code></pre></div>
<p>models.Doc2Vecの部分で学習時のパラメータを設定しています。</p>
<ul>
<li>size: ベクトル化した際の次元数</li>
<li>alpha: 学習率</li>
<li>sample: 単語を無視する際の頻度の閾値</li>
<li>min_count: 学習に使う単語の最低出現回数</li>
<li>workers: 学習時のスレッド数</li>
</ul>
<h5 id="alpha" style="position:relative;"><a href="#alpha" aria-label="alpha permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>alpha</h5>
<p>高いほど収束が速いですが、高すぎると発散します。
低いほど精度が高いですが、収束が遅くなります。</p>
<h5 id="sample" style="position:relative;"><a href="#sample" aria-label="sample permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>sample</h5>
<p>あまりに高い頻度で出現する単語は意味のない単語である可能性が高いので、無視することがあります。
その閾値を設定します。</p>
<h5 id="min_count" style="position:relative;"><a href="#min_count" aria-label="min_count permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>min_count</h5>
<p>sampleとは逆に、頻度が少なすぎる単語もその文章を表現するのに適切でない場合があるので無視することがあります。
ただ、今回はすべての単語を対象にしました。</p>
<div class="gatsby-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span>sentences<span class="token punctuation">)</span>
        ranks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> doc_id <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            inferred_vector <span class="token operator">=</span> model<span class="token punctuation">.</span>infer_vector<span class="token punctuation">(</span>sentences<span class="token punctuation">[</span>doc_id<span class="token punctuation">]</span><span class="token punctuation">.</span>words<span class="token punctuation">)</span>
            sims <span class="token operator">=</span> model<span class="token punctuation">.</span>docvecs<span class="token punctuation">.</span>most_similar<span class="token punctuation">(</span><span class="token punctuation">[</span>inferred_vector<span class="token punctuation">]</span><span class="token punctuation">,</span> topn<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>docvecs<span class="token punctuation">)</span><span class="token punctuation">)</span>
            rank <span class="token operator">=</span> <span class="token punctuation">[</span>docid <span class="token keyword">for</span> docid<span class="token punctuation">,</span> sim <span class="token keyword">in</span> sims<span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">(</span>sentences<span class="token punctuation">[</span>doc_id<span class="token punctuation">]</span><span class="token punctuation">.</span>tags<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            ranks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rank<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>collections<span class="token punctuation">.</span>Counter<span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> collections<span class="token punctuation">.</span>Counter<span class="token punctuation">(</span>ranks<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">>=</span> PASSING_PRECISION<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">return</span> model</code></pre></div>
<p>この部分で学習と評価を行っています。
評価は、学習した文章のうち100個で類似の文章を検索し、最も類似度の高い文章が自分自身だった回数で行います。
今回は94回以上の場合に学習を終了するようにしました。
(何回か回してみてそれ以上に精度が上がらなかったため)</p>
<h4 id="6-学習データを出力" style="position:relative;"><a href="#6-%E5%AD%A6%E7%BF%92%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%87%BA%E5%8A%9B" aria-label="6 学習データを出力 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>6. 学習データを出力</h4>
<div class="gatsby-highlight" data-language="py"><pre class="language-py"><code class="language-py">model<span class="token punctuation">.</span>save<span class="token punctuation">(</span>OUTPUT_MODEL<span class="token punctuation">)</span></code></pre></div>
<p>OUTPUT_MODELには出力するパスが入ります。</p>
<h3 id="単語で文章を検索" style="position:relative;"><a href="#%E5%8D%98%E8%AA%9E%E3%81%A7%E6%96%87%E7%AB%A0%E3%82%92%E6%A4%9C%E7%B4%A2" aria-label="単語で文章を検索 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>単語で文章を検索</h3>
<div class="gatsby-highlight" data-language="py"><pre class="language-py"><code class="language-py">model <span class="token operator">=</span> models<span class="token punctuation">.</span>Doc2Vec<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'doc2vec.model'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">search_similar_texts</span><span class="token punctuation">(</span>words<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> model<span class="token punctuation">.</span>infer_vector<span class="token punctuation">(</span>words<span class="token punctuation">)</span>
    most_similar_texts <span class="token operator">=</span> model<span class="token punctuation">.</span>docvecs<span class="token punctuation">.</span>most_similar<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> similar_text <span class="token keyword">in</span> most_similar_texts<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>similar_text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<p>Doc2Vecでは同時に単語のベクトル化(Word2Vec)も行うので、類似単語も検索するようにしました。</p>
<div class="gatsby-highlight" data-language="py"><pre class="language-py"><code class="language-py"><span class="token keyword">def</span> <span class="token function">search_similar_words</span><span class="token punctuation">(</span>words<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> word <span class="token keyword">in</span> words<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>word <span class="token operator">+</span> <span class="token string">':'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> result <span class="token keyword">in</span> model<span class="token punctuation">.</span>most_similar<span class="token punctuation">(</span>positive<span class="token operator">=</span>word<span class="token punctuation">,</span> topn<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<h4 id="猫で検索した例" style="position:relative;"><a href="#%E7%8C%AB%E3%81%A7%E6%A4%9C%E7%B4%A2%E3%81%97%E3%81%9F%E4%BE%8B" aria-label="猫で検索した例 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>「猫」で検索した例</h4>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; white-space: initial"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/bb96074b5a5f5c344948b3212b343c8e/20751/cat.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 61.904761904761905%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABMElEQVR42q2Ry0rDQBiFZyaXJk0ISWhr0oAExagbN1KS4KY0pu5EBJeKoLlQtakgFHwAH8AXPtKpLRYUTe3icP4Zho855ycv01eMHh6RFyXusxxFOeLz7G5cTfA0rlBNnrmyosRdlvN3K8oL3N5cY/r2DmK3OnCdLbiuC8/zoOs6ZFkGIaS2jk6GINv+DuIowmCQIEkS9Ho9BEEA27ZhmiZUVYUgCGBM4P6dREniwPjscg4MwxD9fh9pmiKOY/i+z0GMMVBKf/0ZZYx7mF7MI7fbbTiOg263C8uyYBgGFEX5c9QVYKvjrNXXj8Dg4HCzwN29fd6VKErLkmfnxVwbaJg2X4Cmaby3ZrO51GIxtYCEChuILHwF0v8DPz06PQehqgna0EAb+tpiqsGBx8MrfAD78x/Vmk1OhAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/bb96074b5a5f5c344948b3212b343c8e/6ea66/cat.webp 315w,
/static/bb96074b5a5f5c344948b3212b343c8e/8aab1/cat.webp 630w,
/static/bb96074b5a5f5c344948b3212b343c8e/7f429/cat.webp 1037w"
              sizes="(max-width: 630px) 100vw, 630px"
              type="image/webp"
            />
          <source
            srcset="/static/bb96074b5a5f5c344948b3212b343c8e/6bdcf/cat.png 315w,
/static/bb96074b5a5f5c344948b3212b343c8e/f058b/cat.png 630w,
/static/bb96074b5a5f5c344948b3212b343c8e/20751/cat.png 1037w"
            sizes="(max-width: 630px) 100vw, 630px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/bb96074b5a5f5c344948b3212b343c8e/f058b/cat.png"
            alt="cat"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h4 id="雪で検索した例" style="position:relative;"><a href="#%E9%9B%AA%E3%81%A7%E6%A4%9C%E7%B4%A2%E3%81%97%E3%81%9F%E4%BE%8B" aria-label="雪で検索した例 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>「雪」で検索した例</h4>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; white-space: initial"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/ae031528ff2b8dd135d4ac2548d1f3fe/20751/snow.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 61.904761904761905%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABLElEQVR42q2Ry0rDUBCGzzlJ2qRJpRgSU4pJyUJrF26EXEghkGrdiQguFUGT9GajICg+gA/gC//Sg0oVCiZ28TEwDB8z/5Cnl1dMZ3Nk+Ri3aYosnyAfTzCeznC/KDBfFCgeHjkpn8lw95ssx831FZ7f3kF0w0TbsmBZFmzbhmEYEEURhJDSHEYjELvrIgwDJEmCZDhEFEVwXReapkGWZS5njEEQhLWIksSF4ekFyK7TReD7iOMYg8EAnufBcZxSW1LGePVPzkF22h1+5vJk0zSh6zqazSbfqpKwYzuV8lor3Ov1IUni5oT7B33UajWe2VfIq08oLWxt61AUBaqq8q82Go1vlv2/ZPlDSAjbQIbCipDS/ws/a3B8BkKVFmhdBa1rlWHKFhcejS7xAThJH6JGHPhOAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/ae031528ff2b8dd135d4ac2548d1f3fe/6ea66/snow.webp 315w,
/static/ae031528ff2b8dd135d4ac2548d1f3fe/8aab1/snow.webp 630w,
/static/ae031528ff2b8dd135d4ac2548d1f3fe/7f429/snow.webp 1037w"
              sizes="(max-width: 630px) 100vw, 630px"
              type="image/webp"
            />
          <source
            srcset="/static/ae031528ff2b8dd135d4ac2548d1f3fe/6bdcf/snow.png 315w,
/static/ae031528ff2b8dd135d4ac2548d1f3fe/f058b/snow.png 630w,
/static/ae031528ff2b8dd135d4ac2548d1f3fe/20751/snow.png 1037w"
            sizes="(max-width: 630px) 100vw, 630px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/ae031528ff2b8dd135d4ac2548d1f3fe/f058b/snow.png"
            alt="snow"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h3 id="類似文章の検索" style="position:relative;"><a href="#%E9%A1%9E%E4%BC%BC%E6%96%87%E7%AB%A0%E3%81%AE%E6%A4%9C%E7%B4%A2" aria-label="類似文章の検索 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>類似文章の検索</h3>
<div class="gatsby-highlight" data-language="py"><pre class="language-py"><code class="language-py">model <span class="token operator">=</span> models<span class="token punctuation">.</span>Doc2Vec<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'doc2vec.model'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">search_similar_texts</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    most_similar_texts <span class="token operator">=</span> model<span class="token punctuation">.</span>docvecs<span class="token punctuation">.</span>most_similar<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">for</span> similar_text <span class="token keyword">in</span> most_similar_texts<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>similar_text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<h4 id="夏目漱石の吾輩は猫であるで検索した例" style="position:relative;"><a href="#%E5%A4%8F%E7%9B%AE%E6%BC%B1%E7%9F%B3%E3%81%AE%E5%90%BE%E8%BC%A9%E3%81%AF%E7%8C%AB%E3%81%A7%E3%81%82%E3%82%8B%E3%81%A7%E6%A4%9C%E7%B4%A2%E3%81%97%E3%81%9F%E4%BE%8B" aria-label="夏目漱石の吾輩は猫であるで検索した例 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>夏目漱石の「吾輩は猫である」で検索した例</h4>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; white-space: initial"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/618eb1949972b1e96faa167d9c4b13ee/20751/natsume.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 61.904761904761905%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABG0lEQVR42s3RO0vDUACG4XPJhWIQIRmCuTXZgo0E0kRFUkPQuokIjopgL7a1TZ06iKs/wD/8SQ5F7CDY1sHh5YMzPBzOIYvXN4wnz6Kn8UTsSOwUs2qO6axCNX8RDUdjPPb66PUHqw2GeLi/w+L9A2TfdkAI+ZMOT7sgluMiCAJ4ngfXdWGaJnRdhyzLYIyBcw62jP+QJMsCPLm8qUEP7XaCPM9RliWyLEMYhlAU5dc3o4yJPbq4BnGaPrIsRadzhqIokKYpoiiCYRibgW4zQKt1gCRJEMcxfN+HbduwLAuapoFSuh7IZRWMUvFe9WG9kiR9tTZIKN/6d1dBJv1HkH8DCd0eXO7x+RUIbeyBqjugqrZxrLErwKR7i08VlyBM9ZAr3QAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/618eb1949972b1e96faa167d9c4b13ee/6ea66/natsume.webp 315w,
/static/618eb1949972b1e96faa167d9c4b13ee/8aab1/natsume.webp 630w,
/static/618eb1949972b1e96faa167d9c4b13ee/7f429/natsume.webp 1037w"
              sizes="(max-width: 630px) 100vw, 630px"
              type="image/webp"
            />
          <source
            srcset="/static/618eb1949972b1e96faa167d9c4b13ee/6bdcf/natsume.png 315w,
/static/618eb1949972b1e96faa167d9c4b13ee/f058b/natsume.png 630w,
/static/618eb1949972b1e96faa167d9c4b13ee/20751/natsume.png 1037w"
            sizes="(max-width: 630px) 100vw, 630px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/618eb1949972b1e96faa167d9c4b13ee/f058b/natsume.png"
            alt="natsume"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h4 id="太宰治の人間失格で検索した例" style="position:relative;"><a href="#%E5%A4%AA%E5%AE%B0%E6%B2%BB%E3%81%AE%E4%BA%BA%E9%96%93%E5%A4%B1%E6%A0%BC%E3%81%A7%E6%A4%9C%E7%B4%A2%E3%81%97%E3%81%9F%E4%BE%8B" aria-label="太宰治の人間失格で検索した例 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>太宰治の「人間失格」で検索した例</h4>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; white-space: initial"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/a697fdf83ecc1bb8f213163ed0afec36/20751/dazai.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 61.904761904761905%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABK0lEQVR42s2RS0vDQBhF55EyeYg1YAxpGaPSLhMK0iQmW607EcGlItiHSdqmXYiCe3+Af/hKBwt2o9W6cHG4uzP3u0Men19QlCXK8QQPeYGiHCMvShTjCabVDJNphWo2V4zyAvf9AfqD4SrDEe5ub/D0+gayu+eCEPInhFkPxGtKSCnheZ7CdV1YlgWh6+CcgzGm8iu0Wk0JT86vQJrSR9TtIssyJEmCTqejHqjX69A0ba1mlDGV8dkliPQPEUUR0jRFHMdK6Ps+HMeBbduqra7rEEKAUvq9cP/gCEEQIAxDtNtttFotNBoNJVy0NAwDpmkq1hLymgCjVG213Gtx6nKfH59MKN/4d1eFTPuPQv5JSOjmwo9MTi9AqLEDKixQsfVrmLGthMe9a7wDAb4gC3Bwy24AAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/static/a697fdf83ecc1bb8f213163ed0afec36/6ea66/dazai.webp 315w,
/static/a697fdf83ecc1bb8f213163ed0afec36/8aab1/dazai.webp 630w,
/static/a697fdf83ecc1bb8f213163ed0afec36/7f429/dazai.webp 1037w"
              sizes="(max-width: 630px) 100vw, 630px"
              type="image/webp"
            />
          <source
            srcset="/static/a697fdf83ecc1bb8f213163ed0afec36/6bdcf/dazai.png 315w,
/static/a697fdf83ecc1bb8f213163ed0afec36/f058b/dazai.png 630w,
/static/a697fdf83ecc1bb8f213163ed0afec36/20751/dazai.png 1037w"
            sizes="(max-width: 630px) 100vw, 630px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/static/a697fdf83ecc1bb8f213163ed0afec36/f058b/dazai.png"
            alt="dazai"
            title=""
            loading="lazy"
            decoding="async"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<h2 id="まとめ" style="position:relative;"><a href="#%E3%81%BE%E3%81%A8%E3%82%81" aria-label="まとめ permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>まとめ</h2>
<p>Doc2Vecで類似文章の検索を実装してみました。
少しでも参考になれば幸いです。</p>
<h2 id="エラーが起きた場合" style="position:relative;"><a href="#%E3%82%A8%E3%83%A9%E3%83%BC%E3%81%8C%E8%B5%B7%E3%81%8D%E3%81%9F%E5%A0%B4%E5%90%88" aria-label="エラーが起きた場合 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>エラーが起きた場合</h2>
<p>私の環境で起きたエラーのみですが、解決した方法を載せます。</p>
<ul>
<li><code class="language-text">Intel MKL FATAL ERROR: Cannot load libmkl_avx2.so or libmkl_def.so.</code></li>
</ul>
<p>anaconda3-4.2.0を使っている場合に起きることがあるようです。
<code class="language-text">conda update numpy</code>で解決しました。</p>
<ul>
<li>Invalid argumentのエラー</li>
</ul>
<p>Bash on Ubuntu on Windowsを使っている場合に起きることがあるようです。
<code class="language-text">export KMP_AFFINITY=disabled</code>で解決しました。</p>
<h2 id="参考" style="position:relative;"><a href="#%E5%8F%82%E8%80%83" aria-label="参考 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参考</h2>
<p><a href="https://deepage.net/bigdata/machine_learning/2016/09/02/word2vec_power_of_word_vector.html" target="_blank" rel="nofollow noopener noreferrer">Word2Vec：発明した本人も驚く単語ベクトルの驚異的な力</a>
<a href="https://deepage.net/machine_learning/2017/01/08/doc2vec.html" target="_blank" rel="nofollow noopener noreferrer">Doc2Vecの仕組みとgensimを使った文書類似度算出チュートリアル</a>
<a href="http://inside.pixiv.net/entry/2016/09/13/161454" target="_blank" rel="nofollow noopener noreferrer">pixiv小説で機械学習したらどうなるのっと【学習済みモデルデータ配布あり】</a>
<a href="http://qiita.com/isaac-otao/items/6d44fdc0cfc8fed53657" target="_blank" rel="nofollow noopener noreferrer">TensorFlowを使って学習率による動きの違いを確認する</a>
<a href="https://radimrehurek.com/gensim/models/doc2vec.html" target="_blank" rel="nofollow noopener noreferrer">models.doc2vec – Deep learning with paragraph2vec</a></p>
<!-- リンク --></section><hr/><footer class="ShareFooter-module--shareFooter--0957f"><button class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><rect width="64" height="64" rx="0" ry="0" fill="#000000"></rect><path d="M 41.116 18.375 h 4.962 l -10.8405 12.39 l 12.753 16.86 H 38.005 l -7.821 -10.2255 L 21.235 47.625 H 16.27 l 11.595 -13.2525 L 15.631 18.375 H 25.87 l 7.0695 9.3465 z m -1.7415 26.28 h 2.7495 L 24.376 21.189 H 21.4255 z" fill="white"></path></svg></button><button class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><rect width="64" height="64" rx="0" ry="0" fill="#0965FE"></rect><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" fill="white"></path></svg></button><button class="react-share__ShareButton" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><svg viewBox="0 0 64 64" width="32" height="32"><rect width="64" height="64" rx="0" ry="0" fill="#009ad9"></rect><path d="M 36.164062 33.554688 C 34.988281 32.234375 33.347656 31.5 31.253906 31.34375 C 33.125 30.835938 34.476562 30.09375 35.335938 29.09375 C 36.191406 28.09375 36.609375 26.78125 36.609375 25.101562 C 36.628906 23.875 36.332031 22.660156 35.75 21.578125 C 35.160156 20.558594 34.292969 19.71875 33.253906 19.160156 C 32.304688 18.640625 31.175781 18.265625 29.847656 18.042969 C 28.523438 17.824219 26.195312 17.730469 22.867188 17.730469 L 14.769531 17.730469 L 14.769531 47.269531 L 23.113281 47.269531 C 26.46875 47.269531 28.886719 47.15625 30.367188 46.929688 C 31.851562 46.695312 33.085938 46.304688 34.085938 45.773438 C 35.289062 45.148438 36.28125 44.179688 36.933594 42.992188 C 37.597656 41.796875 37.933594 40.402344 37.933594 38.816406 C 37.933594 36.621094 37.347656 34.867188 36.164062 33.554688 Z M 22.257812 24.269531 L 23.984375 24.269531 C 25.988281 24.269531 27.332031 24.496094 28.015625 24.945312 C 28.703125 25.402344 29.042969 26.183594 29.042969 27.285156 C 29.042969 28.390625 28.664062 29.105469 27.9375 29.550781 C 27.210938 29.992188 25.84375 30.199219 23.855469 30.199219 L 22.257812 30.199219 Z M 29.121094 41.210938 C 28.328125 41.691406 26.976562 41.925781 25.078125 41.925781 L 22.257812 41.925781 L 22.257812 35.488281 L 25.195312 35.488281 C 27.144531 35.488281 28.496094 35.738281 29.210938 36.230469 C 29.925781 36.726562 30.304688 37.582031 30.304688 38.832031 C 30.304688 40.078125 29.914062 40.742188 29.105469 41.222656 Z M 29.121094 41.210938 M 46.488281 39.792969 C 44.421875 39.792969 42.742188 41.46875 42.742188 43.535156 C 42.742188 45.605469 44.421875 47.28125 46.488281 47.28125 C 48.554688 47.28125 50.230469 45.605469 50.230469 43.535156 C 50.230469 41.46875 48.554688 39.792969 46.488281 39.792969 Z M 46.488281 39.792969 M 43.238281 17.730469 L 49.738281 17.730469 L 49.738281 37.429688 L 43.238281 37.429688 Z M 43.238281 17.730469 " fill="white"></path></svg></button></footer></article></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/search-with-doc2vec/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-647833e5e48acbb3029a.js\"],\"component---src-pages-404-tsx\":[\"/component---src-pages-404-tsx-5399a6810f68c6024345.js\"],\"component---src-pages-about-tsx\":[\"/component---src-pages-about-tsx-4b527ddd8ba4377e952e.js\"],\"component---src-pages-archive-tsx\":[\"/component---src-pages-archive-tsx-b5f2764ff83b85b9c84e.js\"],\"component---src-pages-index-tsx\":[\"/component---src-pages-index-tsx-c4a915b412115baa2725.js\"],\"component---src-pages-works-tsx\":[\"/component---src-pages-works-tsx-f665231776de4112be1e.js\"],\"component---src-templates-blog-post-tsx\":[\"/component---src-templates-blog-post-tsx-3c281975ffaecf472f98.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="22ccb129386c8d35097f";</script><script src="/webpack-runtime-5efa6e5bf4f5a2e0fef5.js" async></script><script src="/framework-644d7e5374973a34c8e6.js" async></script><script src="/app-647833e5e48acbb3029a.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>